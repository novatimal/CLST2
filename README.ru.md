[![Статус](https://img.shields.io/badge/статус-ранняя%20бета-orange)](https://shields.io)


> **Внимание:** Проект находится на стадии ранней беты. Возможны ошибки, отсутствие некоторых функций и частые изменения. Ваши отзывы и помощь приветствуются!

Перевод / Translation:
[English](README.md) | [Русский](README.ru.md)


# Проект CLST2: Создание кибердека на базе Orange Pi Zero 2W

<!-- Здесь будет фото -->

Это репозиторий проекта по созданию карманного персонального компьютера (КПК/кибердека) в ретро-стиле. Устройство основано на одноплатном компьютере Orange Pi Zero 2W и использует кастомные драйверы и детально настроенное Linux-окружение для комфортной работы на маленьком экране.

**Этот README содержит подробные инструкции по сборке, установке ПО и решения проблем, возникших в ходе разработки.**

## I. Концепция и Философия
(Без изменений)

## II. Аппаратные компоненты (Железо)

### Основные компоненты:
*   **Процессорный модуль:** Orange Pi Zero 2W
*   **Дисплей:** SPI 2.4" 320x240 (контроллер ST7789V)
*   **Клавиатура:** M5Stack CardKB (подключение по I2C)
*   **Устройство ввода (мышь):** Аналоговый джойстик, подключенный через Digispark ATTiny85 (эмулирует USB-мышь)
*   **Порт расширения:** Кастомный слот на базе кардридера **NAGRA** для модульных картриджей.
*   **Аудиосистема:** I2S усилитель **MAX98357A** с внешним динамиком.
*   **Система охлаждения:** Вентилятор-турбина **4010 5V** с медными радиаторами.
*   **Питание:** Li-Pol аккумулятор с платой зарядки **TP4056**.
*   **Корпус:** 3D-печать (дизайн в разработке).

### Схема подключения (GPIO)

*(Номера пинов физические, для гребенки 26-pin Orange Pi Zero 2W. Проверьте по актуальной распиновке!)*

| Компонент      | Пин устройства | Пин на Orange Pi Zero 2W | Функция           |
|----------------|----------------|--------------------------|-------------------|
| **Дисплей (SPI1)** | VCC          | 3.3V (Пин 1)             | Питание           |
|                | GND            | GND (Пин 6)              | Земля             |
|                | MOSI           | SPI1_MOSI (Пин 19)       | SPI Data          |
|                | SCLK           | SPI1_SCLK (Пин 23)       | SPI Clock         |
|                | CS             | SPI1_CS (Пин 24)         | SPI Chip Select   |
|                | DC             | PA10 (Пин 7)             | Data/Command      |
|                | RST            | PA0 (Пин 11)             | Reset             |
|                | BL             | PA2 (Пин 13)             | Backlight (PWM)   |
| **Клавиатура (I2C0)**| VCC        | 3.3V (Пин 17)            | Питание           |
|                | GND            | GND (Пин 9)              | Земля             |
|                | SDA            | I2C0_SDA (Пин 3)         | I2C Data          |
|                | SCL            | I2C0_SCL (Пин 5)         | I2C Clock         |
| **Аудио (I2S0)** | VIN          | 5V (Пин 2 или 4)         | Питание усилителя |
|                | GND            | GND (Пин 14 или 20)      | Земля             |
|                | DIN            | I2S0_SDOUT (Пин 12)      | I2S Data Out      |
|                | BCLK           | I2S0_SCLK (Пин 35)       | I2S Bit Clock     |
|                | LRC            | I2S0_LRCK (Пин 38)       | I2S LR Clock      |
| **Вентилятор** | VCC (+)        | 5V (Пин 2 или 4)         | Питание           |
|                | GND (-)        | GND (через транзистор)   | Земля             |
|                | CTRL           | PA3 (Пин 15)             | Управление        |
| **Порт NAGRA** | *В разработке* | *Свободные GPIO*         | Кастомная шина    |

*(Устройство мыши на Digispark подключается в один из свободных USB-портов Orange Pi).*

## III. Программное обеспечение (Софт)

### Стек ПО:
*   **ОС:** Armbian (Debian-based) для Orange Pi Zero 2W
*   **Драйвер дисплея:** Кастомная сборка [fbcp-ili9341](https://github.com/juj/fbcp-ili9341).
*   **Драйвер клавиатуры:** Кастомный демон `cardkb_daemon` на C++.
*   **Система охлаждения:** Кастомный демон `fan_control_daemon` на C++.
*   **Аудиодрайвер:** Стандартный драйвер Linux ALSA, настроенный на работу через I2S.
*   **Графическая среда:**
    *   **Оконный менеджер:** Openbox
    *   **Панель задач:** tint2
    *   **Шрифты:** Terminus (растровый, для максимальной четкости)
    *   **Лаунчер:** dmenu

---
<!--(Остальные разделы `README.md` остаются без изменений)!-->

## IV. Установка и Настройка

Следуйте этим шагам для полной настройки системы с нуля.

### Шаг 1: Подготовка SD-карты и ОС

1.  Запишите свежий образ Armbian (Debian-based) для Orange Pi Zero 2W на SD-карту.
2.  Выполните первоначальную настройку системы: создание пользователя, подключение к Wi-Fi.

### Шаг 2: Настройка видеовыхода (Критически важный шаг!)

Чтобы драйвер `fbcp` работал корректно, ядро Linux должно рендерить рабочий стол в "виртуальный" монитор с низким разрешением.

1.  Откройте файл `/boot/armbianEnv.txt` для редактирования:
    ```bash
    sudo nano /boot/armbianEnv.txt
    ```
2.  Добавьте или измените строку `extraargs`, чтобы она включала следующий параметр:
    ```
    extraargs=video=HDMI-A-1:320x240@60
    ```
3.  Сохраните файл (`Ctrl+O`, `Enter`) и **сразу перезагрузите устройство**: `sudo reboot`.

### Шаг 3: Запуск автоматической установки

Скрипт `install.sh` в этом репозитории выполнит все необходимые действия: установит зависимости, включит аппаратные интерфейсы, скомпилирует драйверы и настроит их на автозапуск.

1.  Клонируйте репозиторий:
    ```bash
    git clone https://github.com/ваш_логин/CLST2.git
    cd CLST2
    ```
2.  Сделайте скрипт установки исполняемым:
    ```bash
    chmod +x install.sh
    ```
3.  Запустите скрипт с правами суперпользователя:
    ```bash
    sudo ./install.sh
    ```
4.  Скрипт автоматически включит оверлеи I2C и SPI, установит и скомпилирует `cardkb_daemon` и `fbcp`, а также настроит для них `systemd` сервисы.

### Шаг 4: Финальная перезагрузка

После завершения работы скрипта, он попросит вас перезагрузить устройство. Это необходимо для активации аппаратных интерфейсов (I2C, SPI).
```bash
sudo reboot

---

## V. Настройка рабочего стола Openbox

После установки рекомендуется перейти на легковесный оконный менеджер Openbox для комфортной работы.

1.  **Войдите в сессию Openbox:**
    *   Завершите текущий сеанс (Logout).
    *   На экране входа в систему (Login Screen) кликните по своему имени пользователя.
    *   В правом нижнем углу появится иконка-шестеренка (⚙️). Нажмите на нее и выберите "Openbox".
    *   Введите пароль и войдите.
2.  **Первоначальная настройка:**
    *   Вы увидите пустой серый экран. Кликните правой кнопкой мыши -> Terminal.
    *   Скопируйте стандартные конфиги:
        ```bash
        mkdir -p ~/.config/openbox
        cp /etc/xdg/openbox/* ~/.config/openbox/
        ```
    *   Настройте автозапуск `tint2` и других программ, добавив `#!/bin/bash` в начало и `tint2 &` в конец файла `~/.config/openbox/autostart`. Не забудьте сделать его исполняемым (`chmod +x ~/.config/openbox/autostart`).
3.  **Настройка интерфейса:**
    *   Используйте `nano` для редактирования `~/.config/openbox/rc.xml` и `~/.config/openbox/menu.xml` для настройки шрифтов (рекомендуется `Terminus 9`), меню и горячих клавиш.
    *   Используйте `tint2conf` для графической настройки панели `tint2`.
    *   Установите `lxappearance` для удобной смены тем GTK и иконок.

---

## VI. Отладка и Решение Проблем

Этот раздел описывает проблемы, возникшие в ходе разработки, и их решения. Он может быть полезен, если вы столкнетесь с похожими трудностями.

### Проблема: Не удается изменить разрешение экрана в VirtualBox

*   **Симптом:** При попытке изменить разрешение командой `xrandr` возникает ошибка `BadMatch (invalid parameter attributes)`.
*   **Причина:** Видеодрайвер гостевой ОС в VirtualBox не может корректно обработать кастомный видеорежим.
*   **Решение:**
    1.  **Установить "Дополнения гостевой ОС" (Guest Additions).** Это самый надежный способ.
        *   В ВМ установите зависимости: `sudo apt install build-essential linux-headers-$(uname -r) dkms`. Если установщик будет жаловаться на отсутствие `gcc`, `make`, `perl`, установите их (`sudo apt install gcc make perl`).
        *   В меню VirtualBox выберите "Устройства" -> "Подключить образ диска Дополнений гостевой ОС...".
        *   В терминале ВМ перейдите на смонтированный диск (`cd /media/cdrom0`) и запустите `sudo sh ./VBoxLinuxAdditions.run`.
        *   Перезагрузите ВМ.
    2.  **Использовать `VBoxManage` (если Guest Additions не помогли).**
        *   Выключите ВМ.
        *   На вашем основном компьютере выполните команду: `VBoxManage setextradata "Имя ВМ" "CustomVideoMode1" "320x240x16"`.
        *   **Если команда `VBoxManage` не найдена,** добавьте путь к папке установки VirtualBox (например, `C:\Program Files\Oracle\VirtualBox`) в системную переменную `PATH` вашего ПК.
    3.  **Финальный способ:** Вместо борьбы с `xrandr`, просто **вручную измените размер окна VirtualBox** до примерно 320x240. Благодаря установленным Guest Additions, разрешение внутри ВМ подстроится автоматически.

### Проблема: `tint2` не запускается автоматически с Openbox

*   **Симптом:** После перезапуска Openbox панель `tint2` не появляется, хотя вручную (`tint2 &` в терминале) запускается.
*   **Причина:** Файл `~/.config/openbox/autostart` не является исполняемым или не имеет "шапки" (shebang).
*   **Решение:**
    1.  Убедитесь, что самая первая строка в файле `autostart` — это `#!/bin/bash`.
    2.  Убедитесь, что у файла есть права на исполнение: `chmod +x ~/.config/openbox/autostart`.
    3.  **Если это не помогло, перезагрузите ВМ.** Полная перезагрузка сессии часто решает проблему.

---

## VII. Благодарности (Acknowledgements)

*   Спасибо **Google** за языковую модель **Gemini**, которая выступила в роли AI-ассистента и помогла в разработке и отладке многих программных решений.
*   Спасибо сообществу **Armbian** за отличную сборку Linux для одноплатных компьютеров.
*   Спасибо **juj** за великолепно оптимизированный драйвер `fbcp-ili9341`.






**
      .--.
     |o_o |
     |:_/ |
    //   \ \
   (|     | )
   /`\_   _/`\
   \___)=(___/
   
**
Artwork by (R)(C)Gemini 2.5 pro lol